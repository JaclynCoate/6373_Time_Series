---
title: 'Goal 2 Univaraite: US'
author: "Jaclyn A Coate"
date: "7/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tswge)
library(ggplot2)
library(ggthemes)
```

# US COVID Data

### Data Prep

```{r load data}
us <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6373_Time_Series/master/TermProject/Data/USdaily.7.26.20.csv", header = T, strip.white = T)
us <- transform(us, date = as.Date(as.character(date), "%Y%m%d"))
us <- subset(us, select = -c(states, dateChecked, hospitalized, lastModified, total, posNeg, totalTestResultsIncrease, hash))
us[is.na(us)] <- 0
#Selecting only those dates with reported current hospitilizations
us <- dplyr::slice(us,1:132)
us = us[order(as.Date(us$date, format = "%Y%m%d")),]
head(us)
```

### Stationarity: Current Hospitalizations
It is difficult to assume stationarity for this data due to multiple factors. We are working under the assumption that COVID is a novel virus and cases as well as hospitalizations will eventually return to zero. This being said our current modeling techniques do things such as return to the median or mimic the previously seen trends. Also, we see a heavy wandering trend in both new cases and hospitalization would be dependent on this as well as time. We will review the data and see what, if any, non-stationary components reveal themselves and model the data accordingly.

## Univariate AR/ARMA Modeling

1.  Original Realization Analysis
Traits:
- Heavy wandering behavior 
- What appears to be some noise that could be pseudo-cyclic behavior hidden by the large numbers.

```{r}
ggplot(data = us, aes(x=date, y=hospitalizedCurrently))+
  geom_line(color="orange")+
  labs(title = "Current COVID Hospitalized Cases US", y = "Thousands", x = "") +
    theme_fivethirtyeight()
```

2. Sample Realization, ACF, and Spectral Density
Realization:
  - Heavy wandering behavior 
  - Possible small pseudo-cyclic behavior

ACF:

  - Very slowly dampening behavior that would be consistent with a d=1 ARIMA model.

Spectral Density:

  - Peak at f=0
  - What appears to be a wave through the rest of the graph- this could be a hidden seasonality or another frequency peak that is hidden by the pseudo-cyclic behavior mentioned in above the realization above.

```{r}
plotts.sample.wge(us$hospitalizedCurrently, lag.max = 100)
```

3. Overfit tables
- Since we are seeing heavy wandering behavior we will use overfit tables to see if we can surface any (1-B) factors that have roots very near the unit circle. 

  - Below we are able to clearly see 1: (1-B) factor that has a root nearly on the Unit Circle.

```{r}
est.ar.wge(us$hospitalizedCurrently,p=6,type='burg')
```

4. Difference the data based on surfaced (1-B) Factor
- Once the data has been differenced we see something that looks much closer to a stationary data set. However, we have also surfaced what appears to be a small seasonality component. We see the ACF have higher spikes surface at 7 and 14, which would lead us to believe there is a 7 day seasonal component.

```{r}
us.diff = artrans.wge(us$hospitalizedCurrently, phi.tr = 1, lag.max = 100)
acf(us.diff)
```

5. Seasonailty Transformation
- Above we have surfaced what appears to be a 7 day seasonality trend. We will now transform the data for the s=7.

```{r}
us.diff.seas = artrans.wge(us.diff,phi.tr = c(0,0,0,0,0,0,1), lag.max = 100)
```

6. Diagnose Model w/ aic.wge
- When we diagnose the the best models to use for our stationary data set we see the R AIC5 function selects an AIC ARMA(5,1) model while the BIC selects a AR(2). The AR(2) model is consistent with our pseudo-cyclic data as well as the dampening cyclical sample autocorrelations that are produced by the transformed data. The ARMA(5,1) could also produce these same traits. We will move forward and compare these two models.

```{r}
aic5.wge(us.diff.seas)
aic5.wge(us.diff.seas,type = "bic")
```

7. Diagnose white noise
- Both of the Junge Box test show us that we reject the H null with pvalues that are < 0.05 alpha significance level.

```{r}
ljung.wge(us.diff.seas)$pval
ljung.wge(us.diff.seas, K=48)$pval
```

8. Estiamte Phis and Thetas
- AIC Phi and Theta Estimates

```{r}
est.us.diff.seasAIC = est.arma.wge(us.diff.seas, p = 5, q=1)
mean(us$hospitalizedCurrently)
```

- BIC Phi Estiamtes

```{r}
est.us.diff.seasBIC = est.arma.wge(us.diff.seas, p = 2)
mean(us$hospitalizedCurrently)
```

### Univariate ARIMA(5,1,1), s=7 Forecasting
#### Short Term
```{r}
shortARMA <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasAIC$phi, theta = est.us.diff.seasAIC$theta, d= 1, s = 7, n.ahead = 7, lastn = F, limits = T)
```

- AIC
```{r}
est.us.diff.seasAIC$aic
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasAIC$phi
thetas = est.us.diff.seasAIC$theta

trainingSize = 24
horizon = 7
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1, n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - shortARMA$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 7, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

#### Long Term

```{r}
longARMA <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasAIC$phi, theta = est.us.diff.seasAIC$theta, d= 1, s = 7, n.ahead = 90, lastn = F, limits = F)
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasAIC$phi
thetas = est.us.diff.seasAIC$theta

trainingSize = 24
horizon = 90
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - longARMA$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1, n.ahead = 90, lastn = T)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

### Univariate ARIMA(2,1,0), s=7 Forecasting

#### Short Term
```{r}
shortAR <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasBIC$phi, d=1, s=7, n.ahead = 7, lastn = FALSE, limits = FALSE)
```

- AIC
```{r}
est.us.diff.seasBIC$aic
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasBIC$phi
thetas = est.us.diff.seasBIC$theta

trainingSize = 24
horizon = 7
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1, n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - shortAR$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 7, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

#### Long Term
```{r}
longAR <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasBIC$phi, s= 7, d = 1, n.ahead = 90, lastn = FALSE, limits = FALSE)
```

- ASE
```{r}
ASElongAR = mean((us$hospitalizedCurrently[(124-90+1):124]-longAR$f)^2)
ASElongAR 
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasBIC$phi
thetas = est.us.diff.seasBIC$theta

trainingSize = 24
horizon = 90
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - longAR$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
ASEHolder
hist(ASEHolder)
WindowedASE = mean(ASEHolder)
```

```{r}
summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 90, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```


#### Univariate MLR w/ Correlated Errors
MLR w/ Correlated Errors
1. Stationarize data

```{r}
#Stationarize Currently Hospitalized Variable
us.diff = artrans.wge(us$hospitalizedCurrently, phi.tr = 1, lag.max = 100)
acf(us.diff)
us.diff.seas = artrans.wge(us.diff,phi.tr = c(0,0,0,0,0,0,1), lag.max = 100)
acf(us.diff.seas)
#Stationarize Increase Positive Variable
inpos.diff = artrans.wge(us$positiveIncrease, phi.tr = 1, lag.max = 100)
acf(inpos.diff)
inpos.diff.seas = artrans.wge(inpos.diff,phi.tr = c(0,0,0,0,0,0,1), lag.max = 100)
acf(inpos.diff.seas)
```

2. Fit a simple 
    
```{r}
lm.fit2 = lm(us.diff.seas~inpos.diff.seas, data=cbind(data.frame(us.diff.seas), data.frame(inpos.diff.seas)))
summary(lm.fit2)
AIC(lm.fit2)
acf(lm.fit2$residuals)
plot(lm.fit2$residuals)
```

3. Diagnose a model using aic.wge: ARMA(5,2)

```{r}
lm.phis= aic.wge(lm.fit2$residuals)
lm.phis
```

4. Fit an aruma model

```{r}
us.fit.2 = arima(us$hospitalizedCurrently, order = c(5,1,2), seasonal = list(order = c(1,0,0), period = 7))
us.fit.2
AIC(us.fit.2)
```

5. Checking for white noise: failure to to reject the H_null tells us the remainer of the data cannot be determined as any different than white noise.

```{r}
acf(us.fit.2$residuals)
ljung.wge(us.fit.2$residuals) # pval = .1493
```

6. Predictions
- 7 Day Predictions

```{r}
us.preds7 = predict(us.fit.2, n.ahead = 7)
us.preds7$pred
```

- 90 Day Predictions

```{r}
us.preds90 = predict(us.fit.2, n.ahead = 90)
us.preds90$pred
```

7. Visualiztion of predictions
- 7 Day Forecast

```{r}
#7 Day Forecast
plot(seq(1,132,1), us$hospitalizedCurrently, type = "l", xlim = c(0,140), ylab = "Currently Hospitalized COVID Patients", main = "Currently Hospitalized COVID Patients 7 Day Forecast")
lines(seq(133, 139, 1), us.preds7$pred, type= "l", col = "red")
```

- 90 Day Forecast

```{r}
#90 Day Forecast
plot(seq(1,132,1), us$hospitalizedCurrently, type = "l", xlim = c(0,225), ylab = "Currently Hospitalized COVID Patients", main = "Currently Hospitalized COVID Patients 90 Day Forecast")
lines(seq(133, 222, 1), us.preds90$pred, type= "l", col = "red")
```

8. Windowed ASE 
- 7 Day Windowed ASE

```{r}
```

- 90 Day Windowed ASE

```{r fig.show="hide", warning=FALSE}
#phis = est.us.diff.seasBIC$phi
#thetas = est.us.diff.seasBIC$theta

#trainingSize = 24
#horizon = 90
#ASEHolder = numeric()

#for( i in 1:(124-(trainingSize + horizon) + 1))
#{
#  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
#  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - longAR$f)^2)
         
#  ASEHolder[i] = ASE
#}
```

```{r}
#ASEHolder
#hist(ASEHolder)
#WindowedASE = mean(ASEHolder)
```

```{r}
#summary(ASEHolder)
#WindowedASE
```

```{r}
#fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 90, lastn = TRUE)
#ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
#ASE
```

## Univariate MLP / Neural Network Model
1. Creating train / test data set

```{r}
library(nnfor)
head(us)
usTrain.nn = ts(us$hospitalizedCurrently[1:122])
```

2. Fitting NN model
  a. Fitted model on train data set. We did this to see just how different merely 7 days can mean to a model.

```{r}
us.nn.fit = mlp(usTrain.nn, outplot = T, comb = "mean", m=7, reps = 50)
plot(us.nn.fit)
```
  b. Fitted a model on the full data set. It shows that the same model is developed but we want to see how this affects our forecast. We suspect a data point up or down can drastically change the trend of the forecast.
  
```{r}
us.nn.fit2 = mlp(ts(us$hospitalizedCurrently), outplot = T, comb = "mean", m=7, reps = 50)
plot(us.nn.fit2)
```

3. Forecast horizon/step forward
  a. With jus tthe trained data set being used we see a very highly likely hood of increased trend. We don't see a lot of hope for the severity of the cases dropping.

```{r}
us.nn.fit.fore = forecast(us.nn.fit, h=10)
plot(us.nn.fit.fore)
```
  b. As we suspected the forecast drastically changes for that of the full data set than the trained. We can see that those extra days of showing a downward trend project a much more manageable curve for COVID and what might be the need for forecasting supplies etc. This is important to take into account and means a daily update of the model would be needed to accurately forecast any future trend or predictions.

```{r}
us.nn.fit.fore2 = forecast(us.nn.fit2, h=10)
plot(us.nn.fit.fore2)
```

4. Plot forecast against test set
  
```{r}
plot(us$hospitalizedCurrently[123:132], type = "l", ylim = c(55000, 80000))
lines(seq(1:10), us.nn.fit.fore$mean, col = "blue")
```

5. Simple ASE

```{r}
ASEus.nn.fit.fore = mean((us$hospitalizedCurrently[123:132]-us.nn.fit.fore$mean)^2)
ASEus.nn.fit.fore
```

6. Windowed ASE

```{r}
library(tswgewrapped)
```

```{r}
data_train.u <- data.frame(hospitalizedCurrently = us$hospitalizedCurrently[1:122], positiveIncrease = rnorm(122, 0, .0001))
data_test.u <- data.frame(hospitalizedCurrently = us$hospitalizedCurrently[123:132], positiveIncrease = rnorm(10, 0, .0001))
```

```{r}
# search for best NN hyperparameters in given grid
model.u = tswgewrapped::ModelBuildNNforCaret$new(data = data_train.u, var_interest = "hospitalizedCurrently",
                                               search = 'random', tuneLength = 5, parallel = TRUE,
                                               batch_size = 50, h = 7, m = 7,
                                               verbose = 1)
```

  - The ASEs associated with the grid of hyperparameters is shown in the table and heatmap below.

```{r}
res.u <- model.u$summarize_hyperparam_results()
res.u
```

```{r}
model.u$plot_hyperparam_results()
```

  - The best hyperparemeters are shown below

```{r}
best.u <- model.u$summarize_best_hyperparams()
best.u
```

```{r}
final.ase.u <- dplyr::filter(res.u, reps == best.u$reps &
                    hd == best.u$hd &
                    allow.det.season == best.u$allow.det.season)[['ASE']]
final.ase.u
```

  - The best hyperparameters based on this grid search are 16 repetitions and 1 hidden layers, and allow.det.season = FALSE which has a mean windowed ASE of 12,177,586.

```{r}
# Ensemble / Hypertuned NN Model
caret_model.u = model.u$get_final_models(subset = 'a')
caret_model.u$finalModel
```


## Ensemble Model / Hypertuned NN Model
We have leveraged the tswgewrapper code above to produce a hyperparameter tuned NN model for our ensemble model. This model will work as our higher functioning ensemble model. Below are the steps to surface the best hyperparameters based on our grid search

  - The best hyperparameters based on this grid search are 16 repetitions and 1 hidden layers, and allow.det.season = FALSE which has a mean windowed ASE of 12,177,586.

```{r}
#Ensemble Model
caret_model.u = model.u$get_final_models(subset = 'a')
caret_model.u$finalModel
```

  - Plot final model

```{r}
#Plot Final Model
plot(caret_model.u$finalModel)
```

  - Forecast 7 Day

```{r}
fore7.u = forecast(caret_model.u$finalModel, h=7)
plot(fore7.u)
```

  - Forecast 90 Day
  
```{r}
fore90.u = forecast(caret_model.u$finalModel, h=90)
plot(fore90.u)
```