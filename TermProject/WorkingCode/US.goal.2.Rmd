---
title: 'Goal 2 Univaraite: US'
author: "Jaclyn A Coate"
date: "7/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tswge)
library(ggplot2)
library(ggthemes)
```

# US COVID Data

## Data Prep

```{r load data}
us <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6373_Time_Series/master/TermProject/Data/USdaily7.19.csv", header = T, strip.white = T)
us <- transform(us, date = as.Date(as.character(date), "%Y%m%d"))
us <- subset(us, select = -c(states, dateChecked, hospitalized, lastModified, total, posNeg, totalTestResultsIncrease, hash))
us[is.na(us)] <- 0
#Selecting only those dates with reported current hospitilizations
us <- dplyr::slice(us,1:124)
us = us[order(as.Date(us$date, format = "%Y%m%d")),]
head(us)
```

## Forecast Current Hospitalizations
It is difficult to assume stationarity for this data due to multiple factors. We are working under the assumption that COVID is a novel virus and cases as well as hospitalizations will eventually return to zero. This being said our current modeling techniques do things such as return to the median or mimic the previously seen trends. Also, we see a severe upward trend in both new cases and hospitalization would be dependent on this as well as time. We will review the data and see what, if any, non-stationary components reveal themselves and model the data accordingly.

### Original Data Realization
Traits:
- Heavy wandering behavior 
- What appears to be some noise that could be pseudo-cyclic behavior hidden by the large numbers.

```{r}
ggplot(data = us, aes(x=date, y=hospitalizedCurrently))+
  geom_line(color="orange")+
  labs(title = "Current COVID Hospitalized Cases US", y = "Thousands", x = "") +
  theme_hc()
```

### Sample Realization, ACF, and Spectral Density
Realization
- Heavy wandering behavior 
- Possible small pseudo-cyclic behavior
ACF
- Very slowly dampening behavior that would be consistent with a d=1 ARIMA model.
Spectral Density
- Peak at f=0
- What apepars to be a wave through the rest of the graph- this could be a hidden seasonailty cause another freq peak that is hidden by the pseudo-cyclic behavior mentioned in about the realization above.

```{r}
plotts.sample.wge(us$hospitalizedCurrently)
```

### Overfit tables
Since we are seeing heavy wandering behavior we will use overfit tables to see if we can surface any (1-B) factors that have roots very near the unit circle.
- Below we are able to clearly see 1: (1-B) factor that has a root nearly on the Unit Circle.

```{r}
est.ar.wge(us$hospitalizedCurrently,p=6,type='burg')
```

### Difference the data based on surfaced (1-B) Factor
Once the data has been differed we something that looks much closer to a stationary data set. However, we have also surfaced what appears to be a small seasonality component. We see the ACF have higher spikes surface at 7 and 14, which would lead us to believe there is a 7 day seasonal component.

```{r}
us.diff = artrans.wge(us$hospitalizedCurrently, phi.tr = 1)
```

### Seasonailty Transformation
Above we have surfaced what appears to be a 7 day seasonality trend. We will now transform the data for the s=7.

```{r}
us.diff.seas = artrans.wge(us.diff,phi.tr = c(0,0,0,0,0,0,1))
```

### Diagnose Model w/ aic.wge
When we diagnose the the best models to use for our stationary data set we see the AIC select a ARMA(5,1) model while the BIC selects a AR(2). The AR(2) model is consistent with our pseudo-cyclic data as well as the dampening cyclical sample autocorrelations that are produced by the transformed data. The ARMA(5,1) could also produce these same traits. We will move forward and compare these two models.

```{r}
aic5.wge(us.diff.seas)
aic5.wge(us.diff.seas,type = "bic")
```

### Diagnose white noise
Both of the Junge Box test show us that we reject the H null with pvalues that are < 0.05 alpha significance level.

```{r}
ljung.wge(us.diff.seas)$pval
ljung.wge(us.diff.seas, K=48)$pval
```

### Estiamte Phis and Thetas
AIC Phi and Theta Estimates
```{r}
est.us.diff.seasAIC = est.arma.wge(us.diff.seas, p = 5, q=1)
mean(us$hospitalizedCurrently)
```

BIC Phi Estiamtes
```{r}
est.us.diff.seasBIC = est.arma.wge(us.diff.seas, p = 2)
mean(us$hospitalizedCurrently)
```

### Forecasts

#### ARMA(5,1)
ARMA(5,1) Short Term
```{r}
shortARMA <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasAIC$phi, theta = est.us.diff.seasAIC$theta, d= 1, s = 7, n.ahead = 7, lastn = FALSE, limits = FALSE)
```

- ASE
```{r}
ASEshortARMA1 = mean((us$hospitalizedCurrently[(124-7+1):124]-shortARMA$f)^2)
ASEshortARMA1 

ASEshortARMA2 = mean((shortARMA$f-us$hospitalizedCurrently[(length(us$hospitalizedCurrently)-6):length(us$hospitalizedCurrently)])^2)
ASEshortARMA2
```

- Windowed ASE
```{r}
```

ARMA(5,1) Long Term
```{r}
longARMA <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasAIC$phi, theta = est.us.diff.seasAIC$theta, d= 1, s = 7, n.ahead = 90, lastn = FALSE, limits = FALSE)
```

- ASE
```{r}
ASElongARMA1 = mean((us$hospitalizedCurrently[(124-90+1):124]-shortARMA$f)^2)
ASElongARMA1 

ASElongARMA2 = mean((shortARMA$f-us$hospitalizedCurrently[(length(us$hospitalizedCurrently)-89):length(us$hospitalizedCurrently)])^2)
ASElongARMA2
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasAIC$phi
thetas = est.us.diff.seasAIC$theta

trainingSize = 25
horizon = 12
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - shortARMA$f)^2)
         
  ASEHolder[i] = ASE

}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
i = 45
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 7, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

#### AR(2)

AR(2) Short Term
```{r}
shortAR <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasBIC$phi, d = 1, s = 7, n.ahead = 7, lastn = FALSE, limits = FALSE)
```

AR(2) Long Term
```{r}
longAR <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasBIC$phi, d = 1, s = 7, n.ahead = 90, lastn = FALSE, limits = FALSE)
```

