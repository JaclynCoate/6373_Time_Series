---
title: 'Goal 2 Univaraite: US'
author: "Jaclyn A Coate"
date: "7/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tswge)
library(ggplot2)
library(ggthemes)
```

# US COVID Data

## Data Prep

```{r load data}
us <- read.csv("https://raw.githubusercontent.com/JaclynCoate/6373_Time_Series/master/TermProject/Data/USdaily.7.26.20.csv", header = T, strip.white = T)
us <- transform(us, date = as.Date(as.character(date), "%Y%m%d"))
us <- subset(us, select = -c(states, dateChecked, hospitalized, lastModified, total, posNeg, totalTestResultsIncrease, hash))
us[is.na(us)] <- 0
#Selecting only those dates with reported current hospitilizations
us <- dplyr::slice(us,1:132)
us = us[order(as.Date(us$date, format = "%Y%m%d")),]
head(us)
```

## Forecast Current Hospitalizations
It is difficult to assume stationarity for this data due to multiple factors. We are working under the assumption that COVID is a novel virus and cases as well as hospitalizations will eventually return to zero. This being said our current modeling techniques do things such as return to the median or mimic the previously seen trends. Also, we see a heavy wandering trend in both new cases and hospitalization would be dependent on this as well as time. We will review the data and see what, if any, non-stationary components reveal themselves and model the data accordingly.

### Original Data Realization
Traits:

- Heavy wandering behavior 
- What appears to be some noise that could be pseudo-cyclic behavior hidden by the large numbers.

```{r}
ggplot(data = us, aes(x=date, y=hospitalizedCurrently))+
  geom_line(color="orange")+
  labs(title = "Current COVID Hospitalized Cases US", y = "Thousands", x = "") +
    theme_fivethirtyeight()
```

### Sample Realization, ACF, and Spectral Density
Realization:

  - Heavy wandering behavior 
  - Possible small pseudo-cyclic behavior

ACF:

  - Very slowly dampening behavior that would be consistent with a d=1 ARIMA model.

Spectral Density:

  - Peak at f=0
  - What appears to be a wave through the rest of the graph- this could be a hidden seasonality or another frequency peak that is hidden by the pseudo-cyclic behavior mentioned in above the realization above.

```{r}
plotts.sample.wge(us$hospitalizedCurrently, lag.max = 100)
```

### Overfit tables
Since we are seeing heavy wandering behavior we will use overfit tables to see if we can surface any (1-B) factors that have roots very near the unit circle. 

  - Below we are able to clearly see 1: (1-B) factor that has a root nearly on the Unit Circle.

```{r}
est.ar.wge(us$hospitalizedCurrently,p=6,type='burg')
```

### Difference the data based on surfaced (1-B) Factor
Once the data has been differenced we see something that looks much closer to a stationary data set. However, we have also surfaced what appears to be a small seasonality component. We see the ACF have higher spikes surface at 7 and 14, which would lead us to believe there is a 7 day seasonal component.

```{r}
us.diff = artrans.wge(us$hospitalizedCurrently, phi.tr = 1, lag.max = 100)
acf(us.diff)
```

### Seasonailty Transformation
Above we have surfaced what appears to be a 7 day seasonality trend. We will now transform the data for the s=7.

```{r}
us.diff.seas = artrans.wge(us.diff,phi.tr = c(0,0,0,0,0,0,1), lag.max = 100)
```

### Diagnose Model w/ aic.wge
When we diagnose the the best models to use for our stationary data set we see the R AIC5 function selects an AIC ARMA(5,1) model while the BIC selects a AR(2). The AR(2) model is consistent with our pseudo-cyclic data as well as the dampening cyclical sample autocorrelations that are produced by the transformed data. The ARMA(5,1) could also produce these same traits. We will move forward and compare these two models.

```{r}
aic5.wge(us.diff.seas)
aic5.wge(us.diff.seas,type = "bic")
```

### Diagnose white noise
Both of the Junge Box test show us that we reject the H null with pvalues that are < 0.05 alpha significance level.

```{r}
ljung.wge(us.diff.seas)$pval
ljung.wge(us.diff.seas, K=48)$pval
```

### Estiamte Phis and Thetas
AIC Phi and Theta Estimates
```{r}
est.us.diff.seasAIC = est.arma.wge(us.diff.seas, p = 5, q=1)
mean(us$hospitalizedCurrently)
```

BIC Phi Estiamtes
```{r}
est.us.diff.seasBIC = est.arma.wge(us.diff.seas, p = 2)
mean(us$hospitalizedCurrently)
```

### Univariate Forecasts

#### ARIMA(5,1,1), s=7
##### Short Term
```{r}
shortARMA <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasAIC$phi, theta = est.us.diff.seasAIC$theta, d= 1, s = 7, n.ahead = 7, lastn = F, limits = T)
```

- AIC
```{r}
est.us.diff.seasAIC$aic
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasAIC$phi
thetas = est.us.diff.seasAIC$theta

trainingSize = 24
horizon = 7
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1, n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - shortARMA$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 7, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

##### Long Term

```{r}
longARMA <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasAIC$phi, theta = est.us.diff.seasAIC$theta, d= 1, s = 7, n.ahead = 90, lastn = F, limits = F)
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasAIC$phi
thetas = est.us.diff.seasAIC$theta

trainingSize = 24
horizon = 90
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - longARMA$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1, n.ahead = 90, lastn = T)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

#### ARIMA(2,1,0)

##### Short Term
```{r}
shortAR <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasBIC$phi, d=1, s=7, n.ahead = 7, lastn = FALSE, limits = FALSE)
```

- AIC
```{r}
est.us.diff.seasBIC$aic
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasBIC$phi
thetas = est.us.diff.seasBIC$theta

trainingSize = 24
horizon = 7
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1, n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - shortAR$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
invisible(ASEHolder)
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 7, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```

##### Long Term
```{r}
longAR <- fore.aruma.wge(us$hospitalizedCurrently, phi = est.us.diff.seasBIC$phi, s= 7, d = 1, n.ahead = 90, lastn = FALSE, limits = FALSE)
```

- ASE
```{r}
ASElongAR = mean((us$hospitalizedCurrently[(124-90+1):124]-longAR$f)^2)
ASElongAR 
```

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
phis = est.us.diff.seasBIC$phi
thetas = est.us.diff.seasBIC$theta

trainingSize = 24
horizon = 90
ASEHolder = numeric()

for( i in 1:(124-(trainingSize + horizon) + 1))
{
  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - longAR$f)^2)
         
  ASEHolder[i] = ASE
}
```

```{r}
ASEHolder
hist(ASEHolder)
WindowedASE = mean(ASEHolder)
```

```{r}
summary(ASEHolder)
WindowedASE
```

```{r}
fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 90, lastn = TRUE)
ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
ASE
```


#### MLR w/ Correlated Errors
MLR w/ Correlated Errors
    a. Fit a simple 

```{r}
us.lm.fit = lm(hospitalizedCurrently~date, data = us)
us.lm.fit
```
    b. Diagnose a model using aic.wge: ARMA(2,1)

```{r}
us.fit.phi = aic.wge(us.lm.fit$residuals)
us.fit.phi
```
    c. Fit an aruma model

```{r}
#without d and s
us.fit.1 = arima(us$hospitalizedCurrently, order = c(us.fit.phi$p,0,us.fit.phi$q))
us.fit.1
AIC(us.fit.1)
```
    d. Checking for white noise: failure to to reject the H_null tells us the remainer of the data cannot be determined as any different than white noise.

```{r}
acf(us.fit.1$residuals)
ljung.wge(us.fit.1$residuals) # pval = .1493
```
  e. Predictions

```{r}
us.preds7 = predict(us.fit.1, n.ahead = 7)
us.preds7$pred
us.preds90 = predict(us.fit.1, n.ahead = 90)
us.preds90$pred
```
  f. Visualiztion of predictions

```{r}
#7 Day Forecast
plot(seq(1,132,1), us$hospitalizedCurrently, type = "l", xlim = c(0,140), ylab = "Currently Hospitalized COVID Patients", main = "Currently Hospitalized COVID Patients 7 Day Forecast")
lines(seq(133, 139, 1), us.preds7$pred, type= "l", col = "red")
```

```{r}
#90 Day Forecast
plot(seq(1,132,1), us$hospitalizedCurrently, type = "l", xlim = c(0,225), ylab = "Currently Hospitalized COVID Patients", main = "Currently Hospitalized COVID Patients 90 Day Forecast")
lines(seq(133, 222, 1), us.preds90$pred, type= "l", col = "red")
```




```{r example code}
# Model cmort based on predicted part and temp using MLR with Cor Erros
#assuming data is loaded in dataframe CM
#ksfit = lm(cmort~temp+part+Week, data = CM)
#phi = aic.wge(ksfit$residuals) #AR(2)

#fit = arima(CM$cmort,order = c(phi$p,0,phi$q), seasonal = list(order = c(1,0,0), period = 52), xreg = cbind(CM$temp, CM$part, CM$Week))

#AIC(fit) #3166

# Check for whiteness of residuals
#acf(fit$residuals)
#ljung.wge(fit$residuals) # pval = .059
#ljung.wge(fit$residuals, K = 48) # pval = .004

#load the forecasted Part and Temp in a data frame
#next20 = data.frame(temp = predsTemp$f, part = predsPart$f, Week = seq(509,528,1))
#get predictions
#predsCMort = predict(fit,newxreg = next20)
#plot next 20 cmort wrt time
#plot(seq(1,508,1), CM$cmort, type = "l",xlim = c(0,528), ylab = "Cardiac Mortality", main = "20 Week Cardiac Mortality Forecast")
#lines(seq(509,528,1), predsCMort$pred, type = "l", col = "red")




#Find ASE  Need to forecast last 30 of known series.  
#CMsmall = CM[1:478,]
#ksfit = lm(cmort~temp+part+Week, data = CMsmall)
#phi = aic.wge(ksfit$residuals)
#fit = arima(CMsmall$cmort,order = c(phi$p,0,0), seasonal = list(order = c(1,0,0), period = 52), xreg = cbind(CMsmall$temp, CMsmall$part, #CMsmall$Week))

#AIC(fit) #2990.101

#last30 = data.frame(temp = CM$temp[479:508], part = CM$part[479:508], CMWeek = seq(479,508,1))
#get predictions
#predsCMort = predict(fit,newxreg = last30)

#ASE = mean((CM$cmort[479:508] - predsCMort$pred)^2)
#ASE #84.2398

#plot(seq(1,508,1), CM$cmort, type = "l",xlim = c(0,528), ylab = "Cardiac Mortality", main = "Last 30 Week Cardiac Mortality Forecast")
#lines(seq(479,508,1), predsCMort$pred, type = "l", col = "red")
```







#### RNN

- Creating train / test data set

```{r}
library(nnfor)
head(us)
usTrain.nn = ts(us$hospitalizedCurrently[1:122])
```

- Fitting NN model on train data set w/ default settings

```{r}
us.nn.fit = mlp(usTrain.nn)
plot(us.nn.fit)
```

- Forecast horizon/step forward 

```{r}
us.nn.fit.fore = forecast(us.nn.fit, h=10)
plot(us.nn.fit.fore)
```

- Plot forecast against test set

```{r}
plot(us$hospitalizedCurrently[123:132], type = "l", ylim = c(55000, 80000))
lines(seq(1:10), us.nn.fit.fore$mean, col = "blue")
```

- Calculate ASE

```{r}
ASEus.nn.fit.fore = mean((us$hospitalizedCurrently[123:132]-us.nn.fit.fore$mean)^2)
ASEus.nn.fit.fore
```

- Rolling Windowed ASE

- Windowed ASE
```{r, fig.show="hide", warning=FALSE}
#phis = est.us.diff.seasBIC$phi
#thetas = est.us.diff.seasBIC$theta

#trainingSize = 24
#horizon = 90
#ASEHolder = numeric()

#for( i in 1:(124-(trainingSize + horizon) + 1))
#{
#  forecasts = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = horizon)
  
#  ASE = mean((us$hospitalizedCurrently[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - longAR$f)^2)
         
#  ASEHolder[i] = ASE
#}
```

```{r}
#ASEHolder
#hist(ASEHolder)
#WindowedASE = mean(ASEHolder)
```

```{r}
#summary(ASEHolder)
#WindowedASE
```

```{r}
#fs = fore.aruma.wge(us$hospitalizedCurrently[i:(i+(trainingSize+horizon)-1)],phi = phis, theta = thetas, s = 7, d = 1,n.ahead = 90, lastn = TRUE)
#ASE = mean((us$hospitalizedCurrently[(i+trainingSize):(i+(trainingSize+horizon)-1)] - fs$f )^2)
#ASE
```


#### Ensemble Model

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```




